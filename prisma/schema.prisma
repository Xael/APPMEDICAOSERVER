// ./prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// MODELO DE UNIDADE DE MEDIDA
// ============================================================
model Unit {
  id        Int       @id @default(autoincrement())
  name      String    // Ex: "Metros Quadrados", "Horas", "Quantidade"
  symbol    String    // Ex: "m²", "h", "qtd"
  services  Service[]
}

// ============================================================
// MODELO DE SERVIÇO
// ============================================================
model Service {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  unitId    Int
  unit      Unit      @relation(fields: [unitId], references: [id])
  locations LocationService[]
  goals     Goal[] // Adicionado
}

// ============================================================
// MODELO DE LOCAL
// ============================================================
model Location {
  id        Int      @id @default(autoincrement())
  city      String   // O frontend chama isso de 'contractGroup'
  name      String
  lat       Float?
  lng       Float?
  observations String?  

  records   Record[]
  services  LocationService[]
}

// ============================================================
// MODELO DE RELACIONAMENTO Local <-> Serviço (Tabela de Junção)
// ============================================================
model LocationService {
  locationId  Int
  serviceId   Int
  measurement Float

  location    Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  service     Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@id([locationId, serviceId])
}

// ============================================================
// MODELO DE UTILIZADOR
// ============================================================
model User {
  id                Int        @id @default(autoincrement())
  email             String     @unique
  name              String
  password          String
  role              String     // ADMIN ou OPERATOR
  assignments       Json?      // Para OPERATOR: { "contractGroup": "Nome do Contrato", "services": ["Serviço A", "Serviço B"] }[]
  records           Record[]
  resetToken        String?
  resetTokenExpires DateTime?
  auditLogs         AuditLog[]
}

// ============================================================
// MODELO DE REGISTO DE SERVIÇO
// ============================================================
model Record {
  id              Int       @id @default(autoincrement())
  operatorId      Int
  serviceId       Int
  serviceType     String
  serviceUnit     String
  locationId      Int?
  locationName    String
  contractGroup   String
  locationArea    Float?
  gpsUsed         Boolean
  startTime       DateTime
  endTime         DateTime?
  beforePhotos    String[]
  afterPhotos     String[]
  operatorName    String

  operator        User      @relation(fields: [operatorId], references: [id])
  location        Location? @relation(fields: [locationId], references: [id])
}

// ===========================================================
// MODELO DE METAS
// ===========================================================
model Goal {
  id            Int      @id @default(autoincrement())
  contractGroup String
  month         String   // Formato "YYYY-MM"
  targetArea    Float
  serviceId     Int      // Adicionado
  service       Service  @relation(fields: [serviceId], references: [id]) // Adicionado
}

// ============================================================
// CONFIGURAÇÕES DE CONTRATO
// ============================================================
model ContractConfig {
  id             Int    @id @default(autoincrement())
  contractGroup  String @unique
  cycleStartDay  Int
}

// ============================================================
// LOGS DE AUDITORIA
// ============================================================
model AuditLog {
  id            Int      @id @default(autoincrement())
  timestamp     DateTime @default(now())
  adminId       Int
  adminUsername String
  action        String   // Ex: 'CREATE', 'UPDATE', 'DELETE'
  recordId      Int
  details       String

  admin         User     @relation(fields: [adminId], references: [id])
}


